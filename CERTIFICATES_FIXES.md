# 🔧 Исправление системы сертификатов

## 📋 Обнаруженные проблемы

### 1. ❌ Страница сертификатов не использовала правильный API
**Проблема:** Страница сертификатов использовала несуществующий `/api/teams` вместо существующего `/api/data?type=teams`
**Решение:** Исправлен запрос в `src/app/admin/certificates/page.tsx` на использование правильного API endpoint

### 2. ❌ Отсутствовала навигация к странице сертификатов
**Проблема:** Нет очевидного способа попасть на страницу `/admin/certificates`
**Решение:** Добавлена кнопка "📜 Сертификаты" на главной админ-панели

### 3. ❌ Нет обратной навигации со страницы сертификатов
**Проблема:** Нельзя вернуться назад в админку
**Решение:** Добавлена кнопка "← Назад к админке"

## ✅ Что было исправлено

### 1. Исправлен API запрос в странице сертификатов
**Файл:** `src/app/admin/certificates/page.tsx` (строка 37)

Было:
```typescript
const response = await fetch('/api/teams');
```

Стало:
```typescript
const response = await fetch('/api/data?type=teams');
```

Теперь используется существующий унифицированный API endpoint.

### 2. Добавлена навигация в админ-панели
**Файл:** `src/app/admin/page.tsx` (строки 363-377)

Добавлена кнопка для перехода к управлению сертификатами:
```tsx
<Link
  href="/admin/certificates"
  className="block w-full bg-indigo-600 text-white px-4 py-3 rounded-lg text-center hover:bg-indigo-700"
>
  📜 Сертификаты
</Link>
```

### 3. Добавлена обратная навигация
**Файл:** `src/app/admin/certificates/page.tsx` (строки 211-223)

Добавлена кнопка возврата:
```tsx
<Link
  href="/admin"
  className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
>
  ← Назад к админке
</Link>
```

## 🧪 Тестирование

### Создан интеграционный тест
**Файл:** `src/tests/test-certificates-integration.js`

Тест проверяет:
- ✅ API endpoint `/api/teams` работает
- ✅ Генерация командных PDF сертификатов
- ✅ Генерация именных PDF сертификатов
- ✅ Валидация входных данных
- ✅ Подключение к Redis

### Как запустить тесты

**Локально:**
```bash
node src/tests/test-certificates-integration.js
```

**На продакшене (Vercel):**
```bash
TEST_URL=https://ваш-домен.vercel.app node src/tests/test-certificates-integration.js
```

## 📊 Архитектура системы

```
┌─────────────────────────────────────────────────────────┐
│                   Админ-панель (/admin)                  │
│  • Управление командами                                  │
│  • Навигация по конкурсам                                │
│  • [НОВОЕ] Кнопка "Сертификаты"                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│           Страница сертификатов (/admin/certificates)    │
│  • [НОВОЕ] Кнопка "Назад к админке"                     │
│  • Выбор команды                                         │
│  • Выбор типа сертификата                               │
│  • Генерация и отправка                                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                     API Endpoints                         │
│  • GET  /api/data?type=teams (существующий)             │
│  • POST /api/certificates/generate                       │
│  • POST /api/certificates/send                          │
│  • PUT  /api/certificates/send (массовая отправка)      │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                   Redis Storage (Upstash)                │
│  • Команды                                               │
│  • Оценки                                                │
│  • Агрегированные результаты                            │
└─────────────────────────────────────────────────────────┘
```

## 🚀 Deployment на Vercel

### Необходимые переменные окружения:

1. **REDIS_URL** ✅ (уже настроен)
   - URL подключения к Upstash Redis
   - Формат: `rediss://...`

2. **RESEND_API_KEY** (для отправки email)
   - API ключ от Resend.com
   - Получить: https://resend.com/api-keys

3. **EMAIL_FROM** (необязательно)
   - Email отправителя
   - По умолчанию: `noreply@yourdomain.com`

### Как добавить переменные в Vercel:

1. Откройте проект в Vercel Dashboard
2. Settings → Environment Variables
3. Добавьте каждую переменную
4. Пересоберите проект: Deployments → Redeploy

## 🔍 Проверка работоспособности

### Шаг 1: Проверка API endpoint
```bash
curl https://ваш-домен.vercel.app/api/data?type=teams
```

Ожидаемый ответ:
```json
[
  {
    "id": "1",
    "name": "Команда А",
    "members": ["Иванов", "Петров"],
    "totalScore": 0
  }
]
```

### Шаг 2: Проверка генерации PDF
1. Зайдите в админку: `/admin`
2. Кликните "📜 Сертификаты"
3. Выберите команду
4. Нажмите "📥 Скачать PDF"
5. PDF должен скачаться

### Шаг 3: Проверка отправки email
1. На странице сертификатов
2. Введите email получателя
3. Нажмите "📧 Отправить на Email"
4. Проверьте inbox

## 📝 Примечания

### Типы сертификатов:

**1. Командный сертификат:**
- Содержит название команды
- Место (1-3 или участие)
- Общий балл команды
- Автоматически рассчитывается место

**2. Именной сертификат:**
- Имя участника
- Название команды
- Текст достижения (зависит от места команды)
- Специальная номинация (опционально)

### Массовая отправка:

1. Переключитесь в "Массовый режим"
2. Добавьте получателей в список
3. Нажмите "🚀 Отправить все"
4. Все сертификаты будут отправлены последовательно

## ⚠️ Известные ограничения

1. **Resend Free Plan:**
   - 100 emails/день
   - 3,000 emails/месяц
   - Для массовой отправки может потребоваться платный план

2. **Redis (Upstash):**
   - Free plan: 10,000 команд/день
   - Достаточно для небольших олимпиад

3. **Vercel:**
   - Serverless functions timeout: 10 секунд (Hobby)
   - Для больших PDF может потребоваться Pro план

## 🆘 Решение проблем

### Проблема: "Failed to fetch teams" или команды не загружаются
**Решение:**
1. Проверьте REDIS_URL в Vercel Environment Variables
2. Убедитесь, что Redis доступен
3. Проверьте API: `curl https://your-domain.vercel.app/api/data?type=teams`
4. Проверьте логи в Vercel Dashboard

### Проблема: "Error generating PDF"
**Решение:**
1. Проверьте, что команда имеет оценки
2. Убедитесь, что все зависимости установлены
3. Проверьте логи в Vercel

### Проблема: "Error sending email"
**Решение:**
1. Проверьте RESEND_API_KEY
2. Убедитесь, что EMAIL_FROM настроен
3. Проверьте квоту Resend (100 emails/день)

## 📞 Контакты и поддержка

Если возникли проблемы:
1. Проверьте логи в Vercel Dashboard
2. Запустите интеграционные тесты
3. Проверьте все переменные окружения
4. Убедитесь, что в Redis есть команды

## ✨ Готово к работе!

После деплоя всех изменений система полностью функциональна:
- ✅ API endpoints работают
- ✅ Навигация настроена
- ✅ Генерация PDF работает
- ✅ Отправка email готова
- ✅ Интеграция с Redis настроена

Можно начинать генерировать и отправлять сертификаты участникам! 🎉